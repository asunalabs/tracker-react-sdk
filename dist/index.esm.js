import{useState as e,useEffect as t,useCallback as n}from"react";const i={serverUrl:"http://localhost:5000/api/track",wsUrl:"ws://localhost:5000/ws",idleTimeout:3e4,checkInterval:1e3,heartbeatInterval:3e4,maxReconnectAttempts:5,enableWebSocket:!0,enableAutoTracking:!0,enableReferralTracking:!0,cookieExpiry:365,debug:!1},o="engage_referral",s="session_id",r="user_id";function a(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function c(e,t,n=365,i){let o=`${e}=${t}; expires=${new Date(Date.now()+24*n*60*60*1e3).toUTCString()}; path=/`;if(i&&""!==i.trim()){const e="undefined"!=typeof window?window.location.hostname:"";if("localhost"===e||"127.0.0.1"===e||/^\d+\.\d+\.\d+\.\d+$/.test(e));else{o+=`; domain=${i.startsWith(".")?i:`.${i}`}`}}return o+="; SameSite=Lax","undefined"!=typeof document&&(document.cookie=o),l(e)||t}function l(e){var t;if("undefined"==typeof document)return;const n=`; ${document.cookie}`.split(`; ${e}=`);return 2===n.length?null===(t=n.pop())||void 0===t?void 0:t.split(";").shift():void 0}function d(e,t){c(e,"",-1,t)}function u(){if("undefined"==typeof window)return{};const e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.substring(1)),n={ref:e.get("ref")||t.get("ref"),referral:e.get("referral")||t.get("referral"),referrer:e.get("referrer")||t.get("referrer"),utm_source:e.get("utm_source"),utm_medium:e.get("utm_medium"),utm_campaign:e.get("utm_campaign"),utm_term:e.get("utm_term"),utm_content:e.get("utm_content"),fbclid:e.get("fbclid"),gclid:e.get("gclid"),msclkid:e.get("msclkid"),source:e.get("source"),medium:e.get("medium"),campaign:e.get("campaign"),affiliate:e.get("affiliate"),partner:e.get("partner")};return Object.fromEntries(Object.entries(n).filter(([,e])=>null!=e))}function h(){if("undefined"==typeof document)return null;const e=document.referrer;if(!e)return null;try{const t=new URL(e).hostname.toLowerCase(),n={"google.com":"google","google.co.uk":"google","google.ca":"google","bing.com":"bing","yahoo.com":"yahoo","duckduckgo.com":"duckduckgo","yandex.com":"yandex","baidu.com":"baidu","facebook.com":"facebook","twitter.com":"twitter","x.com":"twitter","linkedin.com":"linkedin","instagram.com":"instagram","tiktok.com":"tiktok","reddit.com":"reddit","pinterest.com":"pinterest","youtube.com":"youtube","github.com":"github","stackoverflow.com":"stackoverflow","medium.com":"medium"};if(n[t])return{source:n[t],domain:t,url:e};for(const[i,o]of Object.entries(n))if(t.includes(i))return{source:o,domain:t,url:e};return{source:"None / Direct",domain:t,url:e}}catch(t){return{source:"unknown",domain:"unknown",url:e}}}function m(){const e=l(o),t=u(),n=h();if(Object.keys(t).length>0){const e={timestamp:(new Date).toISOString(),urlParams:t,source:n,landingPage:"undefined"!=typeof window?window.location.href:"",userAgent:"undefined"!=typeof navigator?navigator.userAgent:""},i=encodeURIComponent(JSON.stringify(e));return c(o,i,30),e}if(e)try{return JSON.parse(decodeURIComponent(e))}catch(e){}if(n){const e={timestamp:(new Date).toISOString(),urlParams:{},source:n,landingPage:"undefined"!=typeof window?window.location.href:"",userAgent:"undefined"!=typeof navigator?navigator.userAgent:""},t=encodeURIComponent(JSON.stringify(e));return c(o,t,30),e}return null}function g(){try{const e="__engagetrack_test__";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch{return!1}}function f(e,t){let n=null;return function(...i){n&&clearTimeout(n),n=setTimeout(()=>{n=null,e(...i)},t)}}function p(e,t){let n;return function(...i){n||(e(...i),n=!0,setTimeout(()=>n=!1,t))}}class v{constructor(e,t={}){if(this.sessionData=null,this.ws=null,this.heartbeatInterval=null,this.activityInterval=null,this.reconnectAttempts=0,this.onlineUsers=null,this.isInitialized=!1,this.config={...i,...e},this.hooks=t,!this.config.siteId)throw new Error("Site ID is required");if(!this.config.domain)throw new Error("Domain is required");this.init()}init(){if("undefined"!=typeof window)try{this.initializeSession(),this.setupEventListeners(),this.config.enableWebSocket&&this.connectWebSocket(),this.config.enableAutoTracking&&this.startAutoTracking(),this.isInitialized=!0,this.track("session_start"),this.config.enableReferralTracking&&this.trackReferral()}catch(e){this.handleError(e)}else console.warn("EngageTracker: Window is not available, tracking disabled")}initializeSession(){var e,t;const n=l(s)||c(s,a(),1/48,this.config.cookieDomain),i=l(r)||c(r,a(),this.config.cookieExpiry,this.config.cookieDomain);this.sessionData={sessionId:n||a(),userId:i||a(),startTime:Date.now(),lastActivity:Date.now(),isActive:!0,timeSpent:0},null===(t=(e=this.hooks).onSessionStart)||void 0===t||t.call(e,this.sessionData)}setupEventListeners(){if("undefined"==typeof window)return;const e=p(()=>{this.sessionData&&(this.sessionData.lastActivity=Date.now(),this.sessionData.timeSpent=Date.now()-this.sessionData.startTime)},1e3);["mousemove","keydown","scroll","click","touchstart"].forEach(t=>{document.addEventListener(t,e,{passive:!0})}),document.addEventListener("visibilitychange",()=>{document.hidden?(this.track("page_hidden",{timeSpent:this.getTimeSpent()}),this.stopActivityTracking()):this.startActivityTracking()}),document.addEventListener("click",e=>{var t;const n=null===(t=e.target)||void 0===t?void 0:t.closest("a");n&&n.href&&this.trackLinkClick(n,e)}),window.addEventListener("beforeunload",()=>{this.track("page_unload",{timeSpent:this.getTimeSpent()}),this.endSession()}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.track("page_load",{timeSpent:0}),this.track("page_view",{url:window.location.href,title:document.title,timeSpent:0})}):(this.track("page_load",{timeSpent:0}),this.track("page_view",{url:window.location.href,title:document.title,timeSpent:0}))}startActivityTracking(){this.stopActivityTracking(),this.activityInterval=setInterval(()=>{this.checkActivity()},this.config.checkInterval)}stopActivityTracking(){this.activityInterval&&(clearInterval(this.activityInterval),this.activityInterval=null)}checkActivity(){if(!this.sessionData||"undefined"==typeof window)return;const e=Date.now();e-this.sessionData.lastActivity>=this.config.idleTimeout&&(this.track("idle_timeout",{timeSpent:this.getTimeSpent()}),this.sessionData.isActive=!1,this.stopActivityTracking()),this.sessionData.timeSpent=e-this.sessionData.startTime}startAutoTracking(){this.startActivityTracking()}connectWebSocket(){if("undefined"!=typeof window&&this.config.enableWebSocket)try{const e=this.config.wsUrl||this.config.serverUrl.replace("/api/track","").replace("http","ws")+"/ws";this.ws=new WebSocket(e),this.ws.onopen=()=>{var e,t;this.log("WebSocket connected"),this.reconnectAttempts=0,this.startHeartbeat(),null===(t=(e=this.hooks).onWebSocketConnect)||void 0===t||t.call(e)},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleWebSocketMessage(t)}catch(e){this.handleError(new Error("Failed to parse WebSocket message"))}},this.ws.onclose=()=>{var e,t;this.log("WebSocket connection closed"),this.stopHeartbeat(),null===(t=(e=this.hooks).onWebSocketDisconnect)||void 0===t||t.call(e),this.scheduleReconnect()},this.ws.onerror=e=>{this.handleError(new Error("WebSocket error"))}}catch(e){this.handleError(e),this.scheduleReconnect()}}handleWebSocketMessage(e){var t,n,i,o;switch(null===(n=(t=this.hooks).onWebSocketMessage)||void 0===n||n.call(t,e),e.type){case"ping":this.sendWebSocketMessage({type:"pong"});break;case"heartbeat_ack":this.log("Heartbeat acknowledged");break;case"session_end_ack":this.log("Session end acknowledged");break;case"online_users_update":this.onlineUsers=e.data,null===(o=(i=this.hooks).onOnlineUsersUpdate)||void 0===o||o.call(i,e.data)}}sendWebSocketMessage(e){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat()},this.config.heartbeatInterval)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}sendHeartbeat(){this.sessionData&&this.sendWebSocketMessage({type:"heartbeat",siteId:this.config.siteId,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId,timestamp:(new Date).toISOString()})}scheduleReconnect(){if(this.reconnectAttempts<this.config.maxReconnectAttempts){this.reconnectAttempts++;const e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.log(`Scheduling reconnect attempt ${this.reconnectAttempts}/${this.config.maxReconnectAttempts} in ${e}ms`),setTimeout(()=>{this.connectWebSocket()},e)}else this.log("Max reconnection attempts reached")}trackLinkClick(e,t){var n;const i="_blank"===e.target||e.href.startsWith("mailto:")||e.href.startsWith("tel:")||e.hostname&&e.hostname!==window.location.hostname,o={url:e.href,element:(null===(n=e.textContent)||void 0===n?void 0:n.trim())||"Link",isExternal:i,timeSpent:this.getTimeSpent()};i?this.track("user_click",o):(t.preventDefault(),this.trackWithNavigation("user_click",o,()=>{window.location.href=e.href}))}trackWithNavigation(e,t,n){const i=this.buildTrackingPayload(e,t);if(navigator.sendBeacon){if(navigator.sendBeacon(this.config.serverUrl,JSON.stringify(i)))return void n()}fetch(this.config.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),keepalive:!0}).then(()=>n()).catch(()=>n()),setTimeout(n,1e3)}buildTrackingPayload(e,t={}){if(!this.sessionData)return null;const n=m();return{siteId:this.config.siteId,eventType:e.toUpperCase(),domain:this.config.domain,data:{...t,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId,userAgent:"undefined"!=typeof navigator?navigator.userAgent:"",path:"undefined"!=typeof window?window.location.pathname:"",referer:"undefined"!=typeof document?document.referrer:null,title:"undefined"!=typeof document?document.title:null,referral:n,timeSpent:this.getTimeSpent()},timestamp:(new Date).toISOString()}}trackReferral(){var e,t,n,i,o,s,r,a,c,l;const d=m();d&&(this.track("referral_conversion",{referralSource:(null===(e=d.source)||void 0===e?void 0:e.source)||"direct",referralDomain:(null===(t=d.source)||void 0===t?void 0:t.domain)||null,referralUrl:(null===(n=d.source)||void 0===n?void 0:n.url)||null,utmSource:(null===(i=d.urlParams)||void 0===i?void 0:i.utm_source)||null,utmMedium:(null===(o=d.urlParams)||void 0===o?void 0:o.utm_medium)||null,utmCampaign:(null===(s=d.urlParams)||void 0===s?void 0:s.utm_campaign)||null,referralCode:(null===(r=d.urlParams)||void 0===r?void 0:r.ref)||(null===(a=d.urlParams)||void 0===a?void 0:a.referral)||null,landingPage:d.landingPage,referralTimestamp:d.timestamp}),null===(l=(c=this.hooks).onReferralConversion)||void 0===l||l.call(c,d))}endSession(){var e,t;this.sessionData&&(this.sessionData.isActive=!1,this.sessionData.timeSpent=Date.now()-this.sessionData.startTime,this.sendWebSocketMessage({type:"session_end",siteId:this.config.siteId,sessionId:this.sessionData.sessionId,userId:this.sessionData.userId,timeSpent:Math.floor(this.sessionData.timeSpent/1e3),timestamp:(new Date).toISOString()}),this.track("session_end",{timeSpent:this.sessionData.timeSpent,sessionDuration:Math.floor(this.sessionData.timeSpent/1e3)}),null===(t=(e=this.hooks).onSessionEnd)||void 0===t||t.call(e,this.sessionData),this.cleanup())}cleanup(){this.stopActivityTracking(),this.stopHeartbeat(),this.ws&&(this.ws.close(),this.ws=null)}getTimeSpent(){return this.sessionData?Date.now()-this.sessionData.startTime:0}log(e){this.config.debug&&console.log(`[EngageTracker] ${e}`)}handleError(e){var t,n;this.config.debug&&console.error("[EngageTracker] Error:",e),null===(n=(t=this.hooks).onError)||void 0===n||n.call(t,e)}track(e,t={}){var n,i;if(!this.isInitialized)return this.log("Tracker not initialized, queuing event"),void setTimeout(()=>this.track(e,t),100);const o=this.buildTrackingPayload(e,t);o?(fetch(this.config.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).catch(e=>{this.handleError(new Error(`Failed to send tracking event: ${e.message}`))}),null===(i=(n=this.hooks).onTrackingEvent)||void 0===i||i.call(n,e,o.data)):this.handleError(new Error("Failed to build tracking payload"))}trackReferralConversion(e={}){const t=m();this.track("referral_conversion_manual",{...e,referralData:t})}getSessionData(){return this.sessionData}getReferralData(){return m()}getOnlineUsers(){return this.onlineUsers}isConnected(){var e;return(null===(e=this.ws)||void 0===e?void 0:e.readyState)===WebSocket.OPEN}reconnect(){this.reconnectAttempts=0,this.connectWebSocket()}destroy(){this.cleanup(),this.isInitialized=!1}}function k(i,o={}){const[s,r]=e(null),[a,c]=e(!1),[l,d]=e(null),[u,h]=e(null),[m,g]=e(!1);t(()=>{var e;if("undefined"==typeof window)return;const t={...o,onSessionStart:e=>{var t;d(e),null===(t=o.onSessionStart)||void 0===t||t.call(o,e)},onSessionEnd:e=>{var t;d(null),null===(t=o.onSessionEnd)||void 0===t||t.call(o,e)},onWebSocketConnect:()=>{var e;g(!0),null===(e=o.onWebSocketConnect)||void 0===e||e.call(o)},onWebSocketDisconnect:()=>{var e;g(!1),null===(e=o.onWebSocketDisconnect)||void 0===e||e.call(o)},onOnlineUsersUpdate:e=>{var t;h(e),null===(t=o.onOnlineUsersUpdate)||void 0===t||t.call(o,e)}};try{const e=new v(i,t);r(e),c(!0)}catch(t){console.error("Failed to initialize EngageTracker:",t),null===(e=o.onError)||void 0===e||e.call(o,t)}return()=>{s&&s.destroy()}},[i.siteId,i.domain]);const f=n((e,t)=>{s&&s.track(e,t)},[s]),p=n(e=>{s&&s.trackReferralConversion(e)},[s]),k=n(()=>(null==s?void 0:s.getSessionData())||null,[s]),w=n(()=>(null==s?void 0:s.getReferralData())||null,[s]);return{track:f,trackReferralConversion:p,sessionData:l,onlineUsers:u,isConnected:m,isInitialized:a,reconnect:n(()=>{s&&s.reconnect()},[s]),getSessionData:k,getReferralData:w}}function w(n){const[i,o]=e("");t(()=>{if("undefined"==typeof window)return;const e=n||window.location.pathname;e!==i&&o(e)},[n,i])}function S(e,n,i=[]){t(()=>{},i)}function b(){const[n,i]=e(null);return t(()=>{},[]),n}function y(){const[n,i]=e(null);return t(()=>{},[]),n}export{i as DEFAULT_CONFIG,v as EngageTracker,o as REFERRAL_COOKIE_NAME,s as SESSION_COOKIE_NAME,r as USER_COOKIE_NAME,f as debounce,d as deleteCookie,h as detectReferralSource,a as generateId,l as getCookie,m as getReferralData,g as isLocalStorageAvailable,u as parseReferralParams,c as setCookie,p as throttle,k as useEngageTrack,b as useOnlineUsers,w as usePageView,y as useSessionData,S as useTrackEvent};
//# sourceMappingURL=index.esm.js.map
