{"version":3,"file":"index.esm.js","sources":["../src/utils.ts","../src/EngageTracker.ts","../src/useTracking.ts"],"sourcesContent":["import { ReferralData, ReferralSource } from \"./types\";\n\nexport const DEFAULT_CONFIG = {\n\tserverUrl: \"http://localhost:5000/api/track\",\n\twsUrl: \"ws://localhost:5000/ws\",\n\tidleTimeout: 30000, // 30 seconds\n\tcheckInterval: 1000, // 1 second\n\theartbeatInterval: 30000, // 30 seconds\n\tmaxReconnectAttempts: 5,\n\tenableWebSocket: true,\n\tenableAutoTracking: true,\n\tenableReferralTracking: true,\n\tcookieExpiry: 365, // days\n\tdebug: false,\n};\n\nexport const REFERRAL_COOKIE_NAME = \"engage_referral\";\nexport const SESSION_COOKIE_NAME = \"session_id\";\nexport const USER_COOKIE_NAME = \"user_id\";\n\nexport function generateId(): string {\n\tif (typeof crypto !== \"undefined\" && crypto.randomUUID) {\n\t\treturn crypto.randomUUID();\n\t}\n\t// Fallback for older browsers\n\treturn \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g, function (c) {\n\t\tconst r = (Math.random() * 16) | 0;\n\t\tconst v = c === \"x\" ? r : (r & 0x3) | 0x8;\n\t\treturn v.toString(16);\n\t});\n}\n\nexport function setCookie(\n\tname: string,\n\tvalue: string,\n\tdays: number = 365,\n\tdomain?: string\n): string {\n\tconst expires = new Date(\n\t\tDate.now() + days * 24 * 60 * 60 * 1000\n\t).toUTCString();\n\tlet cookieString = `${name}=${value}; expires=${expires}; path=/`;\n\n\tif (domain && domain.trim() !== \"\") {\n\t\tconst hostname =\n\t\t\ttypeof window !== \"undefined\" ? window.location.hostname : \"\";\n\n\t\tif (\n\t\t\thostname === \"localhost\" ||\n\t\t\thostname === \"127.0.0.1\" ||\n\t\t\t/^\\d+\\.\\d+\\.\\d+\\.\\d+$/.test(hostname)\n\t\t) {\n\t\t\t// For localhost/IP, don't set domain attribute\n\t\t} else {\n\t\t\tconst domainValue = domain.startsWith(\".\") ? domain : `.${domain}`;\n\t\t\tcookieString += `; domain=${domainValue}`;\n\t\t}\n\t}\n\n\tcookieString += \"; SameSite=Lax\";\n\n\tif (typeof document !== \"undefined\") {\n\t\tdocument.cookie = cookieString;\n\t}\n\n\treturn getCookie(name) || value;\n}\n\nexport function getCookie(name: string): string | undefined {\n\tif (typeof document === \"undefined\") return undefined;\n\n\tconst value = `; ${document.cookie}`;\n\tconst parts = value.split(`; ${name}=`);\n\tif (parts.length === 2) {\n\t\treturn parts.pop()?.split(\";\").shift();\n\t}\n\treturn undefined;\n}\n\nexport function deleteCookie(name: string, domain?: string): void {\n\tsetCookie(name, \"\", -1, domain);\n}\n\nexport function parseReferralParams(): Record<string, string> {\n\tif (typeof window === \"undefined\") return {};\n\n\tconst urlParams = new URLSearchParams(window.location.search);\n\tconst hashParams = new URLSearchParams(window.location.hash.substring(1));\n\n\tconst referralParams = {\n\t\tref: urlParams.get(\"ref\") || hashParams.get(\"ref\"),\n\t\treferral: urlParams.get(\"referral\") || hashParams.get(\"referral\"),\n\t\treferrer: urlParams.get(\"referrer\") || hashParams.get(\"referrer\"),\n\t\tutm_source: urlParams.get(\"utm_source\"),\n\t\tutm_medium: urlParams.get(\"utm_medium\"),\n\t\tutm_campaign: urlParams.get(\"utm_campaign\"),\n\t\tutm_term: urlParams.get(\"utm_term\"),\n\t\tutm_content: urlParams.get(\"utm_content\"),\n\t\tfbclid: urlParams.get(\"fbclid\"),\n\t\tgclid: urlParams.get(\"gclid\"),\n\t\tmsclkid: urlParams.get(\"msclkid\"),\n\t\tsource: urlParams.get(\"source\"),\n\t\tmedium: urlParams.get(\"medium\"),\n\t\tcampaign: urlParams.get(\"campaign\"),\n\t\taffiliate: urlParams.get(\"affiliate\"),\n\t\tpartner: urlParams.get(\"partner\"),\n\t};\n\n\treturn Object.fromEntries(\n\t\tObject.entries(referralParams).filter(\n\t\t\t([, value]) => value !== null && value !== undefined\n\t\t)\n\t) as Record<string, string>;\n}\n\nexport function detectReferralSource(): ReferralSource | null {\n\tif (typeof document === \"undefined\") return null;\n\n\tconst referrer = document.referrer;\n\tif (!referrer) return null;\n\n\ttry {\n\t\tconst referrerUrl = new URL(referrer);\n\t\tconst referrerDomain = referrerUrl.hostname.toLowerCase();\n\n\t\tconst knownSources: Record<string, string> = {\n\t\t\t\"google.com\": \"google\",\n\t\t\t\"google.co.uk\": \"google\",\n\t\t\t\"google.ca\": \"google\",\n\t\t\t\"bing.com\": \"bing\",\n\t\t\t\"yahoo.com\": \"yahoo\",\n\t\t\t\"duckduckgo.com\": \"duckduckgo\",\n\t\t\t\"yandex.com\": \"yandex\",\n\t\t\t\"baidu.com\": \"baidu\",\n\t\t\t\"facebook.com\": \"facebook\",\n\t\t\t\"twitter.com\": \"twitter\",\n\t\t\t\"x.com\": \"twitter\",\n\t\t\t\"linkedin.com\": \"linkedin\",\n\t\t\t\"instagram.com\": \"instagram\",\n\t\t\t\"tiktok.com\": \"tiktok\",\n\t\t\t\"reddit.com\": \"reddit\",\n\t\t\t\"pinterest.com\": \"pinterest\",\n\t\t\t\"youtube.com\": \"youtube\",\n\t\t\t\"github.com\": \"github\",\n\t\t\t\"stackoverflow.com\": \"stackoverflow\",\n\t\t\t\"medium.com\": \"medium\",\n\t\t};\n\n\t\tif (knownSources[referrerDomain]) {\n\t\t\treturn {\n\t\t\t\tsource: knownSources[referrerDomain],\n\t\t\t\tdomain: referrerDomain,\n\t\t\t\turl: referrer,\n\t\t\t};\n\t\t}\n\n\t\tfor (const [domain, source] of Object.entries(knownSources)) {\n\t\t\tif (referrerDomain.includes(domain)) {\n\t\t\t\treturn {\n\t\t\t\t\tsource: source,\n\t\t\t\t\tdomain: referrerDomain,\n\t\t\t\t\turl: referrer,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tsource: \"None / Direct\",\n\t\t\tdomain: referrerDomain,\n\t\t\turl: referrer,\n\t\t};\n\t} catch (error) {\n\t\treturn {\n\t\t\tsource: \"unknown\",\n\t\t\tdomain: \"unknown\",\n\t\t\turl: referrer,\n\t\t};\n\t}\n}\n\nexport function getReferralData(): ReferralData | null {\n\tconst existingReferral = getCookie(REFERRAL_COOKIE_NAME);\n\tconst urlParams = parseReferralParams();\n\tconst referralSource = detectReferralSource();\n\n\tif (Object.keys(urlParams).length > 0) {\n\t\tconst referralData: ReferralData = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\turlParams: urlParams,\n\t\t\tsource: referralSource,\n\t\t\tlandingPage: typeof window !== \"undefined\" ? window.location.href : \"\",\n\t\t\tuserAgent: typeof navigator !== \"undefined\" ? navigator.userAgent : \"\",\n\t\t};\n\n\t\tconst cookieValue = encodeURIComponent(JSON.stringify(referralData));\n\t\tsetCookie(REFERRAL_COOKIE_NAME, cookieValue, 30); // 30 days\n\n\t\treturn referralData;\n\t}\n\n\tif (existingReferral) {\n\t\ttry {\n\t\t\treturn JSON.parse(decodeURIComponent(existingReferral));\n\t\t} catch (error) {\n\t\t\t// Invalid cookie data, ignore\n\t\t}\n\t}\n\n\tif (referralSource) {\n\t\tconst referralData: ReferralData = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\turlParams: {},\n\t\t\tsource: referralSource,\n\t\t\tlandingPage: typeof window !== \"undefined\" ? window.location.href : \"\",\n\t\t\tuserAgent: typeof navigator !== \"undefined\" ? navigator.userAgent : \"\",\n\t\t};\n\n\t\tconst cookieValue = encodeURIComponent(JSON.stringify(referralData));\n\t\tsetCookie(REFERRAL_COOKIE_NAME, cookieValue, 30); // 30 days\n\n\t\treturn referralData;\n\t}\n\n\treturn null;\n}\n\nexport function isLocalStorageAvailable(): boolean {\n\ttry {\n\t\tconst testKey = \"__engagetrack_test__\";\n\t\tlocalStorage.setItem(testKey, \"test\");\n\t\tlocalStorage.removeItem(testKey);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\nexport function debounce<T extends (...args: any[]) => void>(\n\tfunc: T,\n\twait: number\n): (...args: Parameters<T>) => void {\n\tlet timeout: number | null = null;\n\n\treturn function executedFunction(...args: Parameters<T>) {\n\t\tconst later = () => {\n\t\t\ttimeout = null;\n\t\t\tfunc(...args);\n\t\t};\n\n\t\tif (timeout) {\n\t\t\tclearTimeout(timeout);\n\t\t}\n\t\ttimeout = setTimeout(later, wait) as any;\n\t};\n}\n\nexport function throttle<T extends (...args: any[]) => void>(\n\tfunc: T,\n\tlimit: number\n): (...args: Parameters<T>) => void {\n\tlet inThrottle: boolean;\n\n\treturn function executedFunction(...args: Parameters<T>) {\n\t\tif (!inThrottle) {\n\t\t\tfunc(...args);\n\t\t\tinThrottle = true;\n\t\t\tsetTimeout(() => (inThrottle = false), limit);\n\t\t}\n\t};\n}\n","import {\n\tEngageTrackConfig,\n\tEventType,\n\tEventData,\n\tTrackingData,\n\tSessionData,\n\tReferralData,\n\tWebSocketMessage,\n\tOnlineUsersData,\n\tEngageTrackHooks,\n} from \"./types\";\nimport {\n\tDEFAULT_CONFIG,\n\tgenerateId,\n\tsetCookie,\n\tgetCookie,\n\tgetReferralData,\n\tSESSION_COOKIE_NAME,\n\tUSER_COOKIE_NAME,\n\tdebounce,\n\tthrottle,\n} from \"./utils\";\n\nexport class EngageTracker {\n\tprivate config: EngageTrackConfig;\n\tprivate hooks: EngageTrackHooks;\n\tprivate sessionData: SessionData | null = null;\n\tprivate ws: WebSocket | null = null;\n\tprivate heartbeatInterval: number | null = null;\n\tprivate activityInterval: number | null = null;\n\tprivate reconnectAttempts = 0;\n\tprivate onlineUsers: OnlineUsersData | null = null;\n\tprivate isInitialized = false;\n\n\tconstructor(config: EngageTrackConfig, hooks: EngageTrackHooks = {}) {\n\t\tthis.config = { ...DEFAULT_CONFIG, ...config };\n\t\tthis.hooks = hooks;\n\n\t\tif (!this.config.siteId) {\n\t\t\tthrow new Error(\"Site ID is required\");\n\t\t}\n\n\t\tif (!this.config.domain) {\n\t\t\tthrow new Error(\"Domain is required\");\n\t\t}\n\n\t\tthis.init();\n\t}\n\n\tprivate init(): void {\n\t\tif (typeof window === \"undefined\") {\n\t\t\tconsole.warn(\"EngageTracker: Window is not available, tracking disabled\");\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tthis.initializeSession();\n\t\t\tthis.setupEventListeners();\n\n\t\t\tif (this.config.enableWebSocket) {\n\t\t\t\tthis.connectWebSocket();\n\t\t\t}\n\n\t\t\tif (this.config.enableAutoTracking) {\n\t\t\t\tthis.startAutoTracking();\n\t\t\t}\n\n\t\t\tthis.isInitialized = true;\n\t\t\tthis.track(\"session_start\");\n\n\t\t\tif (this.config.enableReferralTracking) {\n\t\t\t\tthis.trackReferral();\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tthis.handleError(error as Error);\n\t\t}\n\t}\n\n\tprivate initializeSession(): void {\n\t\tconst sessionId =\n\t\t\tgetCookie(SESSION_COOKIE_NAME) ||\n\t\t\tsetCookie(\n\t\t\t\tSESSION_COOKIE_NAME,\n\t\t\t\tgenerateId(),\n\t\t\t\t1 / 48,\n\t\t\t\tthis.config.cookieDomain\n\t\t\t); // 30 minutes\n\t\tconst userId =\n\t\t\tgetCookie(USER_COOKIE_NAME) ||\n\t\t\tsetCookie(\n\t\t\t\tUSER_COOKIE_NAME,\n\t\t\t\tgenerateId(),\n\t\t\t\tthis.config.cookieExpiry,\n\t\t\t\tthis.config.cookieDomain\n\t\t\t);\n\n\t\tthis.sessionData = {\n\t\t\tsessionId: sessionId || generateId(),\n\t\t\tuserId: userId || generateId(),\n\t\t\tstartTime: Date.now(),\n\t\t\tlastActivity: Date.now(),\n\t\t\tisActive: true,\n\t\t\ttimeSpent: 0,\n\t\t};\n\n\t\tthis.hooks.onSessionStart?.(this.sessionData);\n\t}\n\n\tprivate setupEventListeners(): void {\n\t\tif (typeof window === \"undefined\") return;\n\n\t\t// Activity tracking\n\t\tconst updateActivity = throttle(() => {\n\t\t\tif (this.sessionData) {\n\t\t\t\tthis.sessionData.lastActivity = Date.now();\n\t\t\t\tthis.sessionData.timeSpent = Date.now() - this.sessionData.startTime;\n\t\t\t}\n\t\t}, 1000);\n\n\t\t[\"mousemove\", \"keydown\", \"scroll\", \"click\", \"touchstart\"].forEach(\n\t\t\t(event) => {\n\t\t\t\tdocument.addEventListener(event, updateActivity, { passive: true });\n\t\t\t}\n\t\t);\n\n\t\t// Page visibility\n\t\tdocument.addEventListener(\"visibilitychange\", () => {\n\t\t\tif (document.hidden) {\n\t\t\t\tthis.track(\"page_hidden\", { timeSpent: this.getTimeSpent() });\n\t\t\t\tthis.stopActivityTracking();\n\t\t\t} else {\n\t\t\t\tthis.startActivityTracking();\n\t\t\t}\n\t\t});\n\n\t\t// Link click tracking\n\t\tdocument.addEventListener(\"click\", (e) => {\n\t\t\tconst target = (e.target as HTMLElement)?.closest(\"a\");\n\t\t\tif (target && target.href) {\n\t\t\t\tthis.trackLinkClick(target, e);\n\t\t\t}\n\t\t});\n\n\t\t// Page unload\n\t\twindow.addEventListener(\"beforeunload\", () => {\n\t\t\tthis.track(\"page_unload\", { timeSpent: this.getTimeSpent() });\n\t\t\tthis.endSession();\n\t\t});\n\n\t\t// Page load\n\t\tif (document.readyState === \"loading\") {\n\t\t\tdocument.addEventListener(\"DOMContentLoaded\", () => {\n\t\t\t\tthis.track(\"page_load\", { timeSpent: 0 });\n\t\t\t\tthis.track(\"page_view\", {\n\t\t\t\t\turl: window.location.href,\n\t\t\t\t\ttitle: document.title,\n\t\t\t\t\ttimeSpent: 0,\n\t\t\t\t});\n\t\t\t});\n\t\t} else {\n\t\t\tthis.track(\"page_load\", { timeSpent: 0 });\n\t\t\tthis.track(\"page_view\", {\n\t\t\t\turl: window.location.href,\n\t\t\t\ttitle: document.title,\n\t\t\t\ttimeSpent: 0,\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate startActivityTracking(): void {\n\t\tthis.stopActivityTracking();\n\n\t\tthis.activityInterval = setInterval(() => {\n\t\t\tthis.checkActivity();\n\t\t}, this.config.checkInterval!) as any;\n\t}\n\n\tprivate stopActivityTracking(): void {\n\t\tif (this.activityInterval) {\n\t\t\tclearInterval(this.activityInterval);\n\t\t\tthis.activityInterval = null;\n\t\t}\n\t}\n\n\tprivate checkActivity(): void {\n\t\tif (!this.sessionData || typeof window === \"undefined\") return;\n\n\t\tconst currentTime = Date.now();\n\t\tconst timeSinceLastActivity = currentTime - this.sessionData.lastActivity;\n\n\t\tif (timeSinceLastActivity >= this.config.idleTimeout!) {\n\t\t\tthis.track(\"idle_timeout\", { timeSpent: this.getTimeSpent() });\n\t\t\tthis.sessionData.isActive = false;\n\t\t\tthis.stopActivityTracking();\n\t\t}\n\n\t\tthis.sessionData.timeSpent = currentTime - this.sessionData.startTime;\n\t}\n\n\tprivate startAutoTracking(): void {\n\t\tthis.startActivityTracking();\n\t}\n\n\tprivate connectWebSocket(): void {\n\t\tif (typeof window === \"undefined\" || !this.config.enableWebSocket) return;\n\n\t\ttry {\n\t\t\tconst wsUrl =\n\t\t\t\tthis.config.wsUrl ||\n\t\t\t\tthis.config.serverUrl!.replace(\"/api/track\", \"\").replace(\"http\", \"ws\") +\n\t\t\t\t\t\"/ws\";\n\n\t\t\tthis.ws = new WebSocket(wsUrl);\n\n\t\t\tthis.ws.onopen = () => {\n\t\t\t\tthis.log(\"WebSocket connected\");\n\t\t\t\tthis.reconnectAttempts = 0;\n\t\t\t\tthis.startHeartbeat();\n\t\t\t\tthis.hooks.onWebSocketConnect?.();\n\t\t\t};\n\n\t\t\tthis.ws.onmessage = (event) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst message: WebSocketMessage = JSON.parse(event.data);\n\t\t\t\t\tthis.handleWebSocketMessage(message);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.handleError(new Error(\"Failed to parse WebSocket message\"));\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis.ws.onclose = () => {\n\t\t\t\tthis.log(\"WebSocket connection closed\");\n\t\t\t\tthis.stopHeartbeat();\n\t\t\t\tthis.hooks.onWebSocketDisconnect?.();\n\t\t\t\tthis.scheduleReconnect();\n\t\t\t};\n\n\t\t\tthis.ws.onerror = (error) => {\n\t\t\t\tthis.handleError(new Error(\"WebSocket error\"));\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tthis.handleError(error as Error);\n\t\t\tthis.scheduleReconnect();\n\t\t}\n\t}\n\n\tprivate handleWebSocketMessage(message: WebSocketMessage): void {\n\t\tthis.hooks.onWebSocketMessage?.(message);\n\n\t\tswitch (message.type) {\n\t\t\tcase \"ping\":\n\t\t\t\tthis.sendWebSocketMessage({ type: \"pong\" });\n\t\t\t\tbreak;\n\t\t\tcase \"heartbeat_ack\":\n\t\t\t\tthis.log(\"Heartbeat acknowledged\");\n\t\t\t\tbreak;\n\t\t\tcase \"session_end_ack\":\n\t\t\t\tthis.log(\"Session end acknowledged\");\n\t\t\t\tbreak;\n\t\t\tcase \"online_users_update\":\n\t\t\t\tthis.onlineUsers = message.data;\n\t\t\t\tthis.hooks.onOnlineUsersUpdate?.(message.data);\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tprivate sendWebSocketMessage(message: WebSocketMessage): void {\n\t\tif (this.ws && this.ws.readyState === WebSocket.OPEN) {\n\t\t\tthis.ws.send(JSON.stringify(message));\n\t\t}\n\t}\n\n\tprivate startHeartbeat(): void {\n\t\tthis.stopHeartbeat();\n\n\t\tthis.heartbeatInterval = setInterval(() => {\n\t\t\tthis.sendHeartbeat();\n\t\t}, this.config.heartbeatInterval!) as any;\n\t}\n\n\tprivate stopHeartbeat(): void {\n\t\tif (this.heartbeatInterval) {\n\t\t\tclearInterval(this.heartbeatInterval);\n\t\t\tthis.heartbeatInterval = null;\n\t\t}\n\t}\n\n\tprivate sendHeartbeat(): void {\n\t\tif (!this.sessionData) return;\n\n\t\tthis.sendWebSocketMessage({\n\t\t\ttype: \"heartbeat\",\n\t\t\tsiteId: this.config.siteId,\n\t\t\tsessionId: this.sessionData.sessionId,\n\t\t\tuserId: this.sessionData.userId,\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t});\n\t}\n\n\tprivate scheduleReconnect(): void {\n\t\tif (this.reconnectAttempts < this.config.maxReconnectAttempts!) {\n\t\t\tthis.reconnectAttempts++;\n\t\t\tconst delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);\n\n\t\t\tthis.log(\n\t\t\t\t`Scheduling reconnect attempt ${this.reconnectAttempts}/${this.config.maxReconnectAttempts} in ${delay}ms`\n\t\t\t);\n\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.connectWebSocket();\n\t\t\t}, delay);\n\t\t} else {\n\t\t\tthis.log(\"Max reconnection attempts reached\");\n\t\t}\n\t}\n\n\tprivate trackLinkClick(element: HTMLAnchorElement, event: MouseEvent): void {\n\t\tconst isExternal =\n\t\t\telement.target === \"_blank\" ||\n\t\t\telement.href.startsWith(\"mailto:\") ||\n\t\t\telement.href.startsWith(\"tel:\") ||\n\t\t\t(element.hostname && element.hostname !== window.location.hostname);\n\n\t\tconst data = {\n\t\t\turl: element.href,\n\t\t\telement: element.textContent?.trim() || \"Link\",\n\t\t\tisExternal,\n\t\t\ttimeSpent: this.getTimeSpent(),\n\t\t};\n\n\t\tif (isExternal) {\n\t\t\tthis.track(\"user_click\", data);\n\t\t} else {\n\t\t\tevent.preventDefault();\n\t\t\tthis.trackWithNavigation(\"user_click\", data, () => {\n\t\t\t\twindow.location.href = element.href;\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate trackWithNavigation(\n\t\teventType: EventType,\n\t\tdata: EventData,\n\t\tnavigate: () => void\n\t): void {\n\t\tconst payload = this.buildTrackingPayload(eventType, data);\n\n\t\tif (navigator.sendBeacon) {\n\t\t\tconst success = navigator.sendBeacon(\n\t\t\t\tthis.config.serverUrl!,\n\t\t\t\tJSON.stringify(payload)\n\t\t\t);\n\n\t\t\tif (success) {\n\t\t\t\tnavigate();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tfetch(this.config.serverUrl!, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify(payload),\n\t\t\tkeepalive: true,\n\t\t})\n\t\t\t.then(() => navigate())\n\t\t\t.catch(() => navigate());\n\n\t\t// Fallback timeout\n\t\tsetTimeout(navigate, 1000);\n\t}\n\n\tprivate buildTrackingPayload(\n\t\teventType: EventType,\n\t\tdata: TrackingData = {}\n\t): any {\n\t\tif (!this.sessionData) return null;\n\n\t\tconst referralData = getReferralData();\n\n\t\treturn {\n\t\t\tsiteId: this.config.siteId,\n\t\t\teventType: eventType.toUpperCase(),\n\t\t\tdomain: this.config.domain,\n\t\t\tdata: {\n\t\t\t\t...data,\n\t\t\t\tsessionId: this.sessionData.sessionId,\n\t\t\t\tuserId: this.sessionData.userId,\n\t\t\t\tuserAgent: typeof navigator !== \"undefined\" ? navigator.userAgent : \"\",\n\t\t\t\tpath: typeof window !== \"undefined\" ? window.location.pathname : \"\",\n\t\t\t\treferer: typeof document !== \"undefined\" ? document.referrer : null,\n\t\t\t\ttitle: typeof document !== \"undefined\" ? document.title : null,\n\t\t\t\treferral: referralData,\n\t\t\t\ttimeSpent: this.getTimeSpent(),\n\t\t\t},\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t};\n\t}\n\n\tprivate trackReferral(): void {\n\t\tconst referralData = getReferralData();\n\n\t\tif (referralData) {\n\t\t\tthis.track(\"referral_conversion\", {\n\t\t\t\treferralSource: referralData.source?.source || \"direct\",\n\t\t\t\treferralDomain: referralData.source?.domain || null,\n\t\t\t\treferralUrl: referralData.source?.url || null,\n\t\t\t\tutmSource: referralData.urlParams?.utm_source || null,\n\t\t\t\tutmMedium: referralData.urlParams?.utm_medium || null,\n\t\t\t\tutmCampaign: referralData.urlParams?.utm_campaign || null,\n\t\t\t\treferralCode:\n\t\t\t\t\treferralData.urlParams?.ref ||\n\t\t\t\t\treferralData.urlParams?.referral ||\n\t\t\t\t\tnull,\n\t\t\t\tlandingPage: referralData.landingPage,\n\t\t\t\treferralTimestamp: referralData.timestamp,\n\t\t\t});\n\n\t\t\tthis.hooks.onReferralConversion?.(referralData);\n\t\t}\n\t}\n\n\tprivate endSession(): void {\n\t\tif (!this.sessionData) return;\n\n\t\tthis.sessionData.isActive = false;\n\t\tthis.sessionData.timeSpent = Date.now() - this.sessionData.startTime;\n\n\t\t// Send session end via WebSocket\n\t\tthis.sendWebSocketMessage({\n\t\t\ttype: \"session_end\",\n\t\t\tsiteId: this.config.siteId,\n\t\t\tsessionId: this.sessionData.sessionId,\n\t\t\tuserId: this.sessionData.userId,\n\t\t\ttimeSpent: Math.floor(this.sessionData.timeSpent / 1000),\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t});\n\n\t\t// Also send via HTTP as fallback\n\t\tthis.track(\"session_end\", {\n\t\t\ttimeSpent: this.sessionData.timeSpent,\n\t\t\tsessionDuration: Math.floor(this.sessionData.timeSpent / 1000),\n\t\t});\n\n\t\tthis.hooks.onSessionEnd?.(this.sessionData);\n\t\tthis.cleanup();\n\t}\n\n\tprivate cleanup(): void {\n\t\tthis.stopActivityTracking();\n\t\tthis.stopHeartbeat();\n\n\t\tif (this.ws) {\n\t\t\tthis.ws.close();\n\t\t\tthis.ws = null;\n\t\t}\n\t}\n\n\tprivate getTimeSpent(): number {\n\t\treturn this.sessionData ? Date.now() - this.sessionData.startTime : 0;\n\t}\n\n\tprivate log(message: string): void {\n\t\tif (this.config.debug) {\n\t\t\tconsole.log(`[EngageTracker] ${message}`);\n\t\t}\n\t}\n\n\tprivate handleError(error: Error): void {\n\t\tif (this.config.debug) {\n\t\t\tconsole.error(`[EngageTracker] Error:`, error);\n\t\t}\n\t\tthis.hooks.onError?.(error);\n\t}\n\n\t// Public API\n\tpublic track(eventType: EventType, data: TrackingData = {}): void {\n\t\tif (!this.isInitialized) {\n\t\t\tthis.log(\"Tracker not initialized, queuing event\");\n\t\t\tsetTimeout(() => this.track(eventType, data), 100);\n\t\t\treturn;\n\t\t}\n\n\t\tconst payload = this.buildTrackingPayload(eventType, data);\n\n\t\tif (!payload) {\n\t\t\tthis.handleError(new Error(\"Failed to build tracking payload\"));\n\t\t\treturn;\n\t\t}\n\n\t\tfetch(this.config.serverUrl!, {\n\t\t\tmethod: \"POST\",\n\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\tbody: JSON.stringify(payload),\n\t\t}).catch((error) => {\n\t\t\tthis.handleError(\n\t\t\t\tnew Error(`Failed to send tracking event: ${error.message}`)\n\t\t\t);\n\t\t});\n\n\t\tthis.hooks.onTrackingEvent?.(eventType, payload.data);\n\t}\n\n\tpublic trackReferralConversion(data: TrackingData = {}): void {\n\t\tconst referralData = getReferralData();\n\n\t\tthis.track(\"referral_conversion_manual\", {\n\t\t\t...data,\n\t\t\treferralData,\n\t\t});\n\t}\n\n\tpublic getSessionData(): SessionData | null {\n\t\treturn this.sessionData;\n\t}\n\n\tpublic getReferralData(): ReferralData | null {\n\t\treturn getReferralData();\n\t}\n\n\tpublic getOnlineUsers(): OnlineUsersData | null {\n\t\treturn this.onlineUsers;\n\t}\n\n\tpublic isConnected(): boolean {\n\t\treturn this.ws?.readyState === WebSocket.OPEN;\n\t}\n\n\tpublic reconnect(): void {\n\t\tthis.reconnectAttempts = 0;\n\t\tthis.connectWebSocket();\n\t}\n\n\tpublic destroy(): void {\n\t\tthis.cleanup();\n\t\tthis.isInitialized = false;\n\t}\n}\n","import { useEffect, useState, useCallback } from \"react\";\nimport { EngageTracker } from \"./EngageTracker\";\nimport {\n\tEngageTrackConfig,\n\tEventType,\n\tTrackingData,\n\tSessionData,\n\tOnlineUsersData,\n\tReferralData,\n\tEngageTrackHooks,\n} from \"./types\";\n\nexport interface UseEngageTrackReturn {\n\ttrack: (eventType: EventType, data?: TrackingData) => void;\n\ttrackReferralConversion: (data?: TrackingData) => void;\n\tsessionData: SessionData | null;\n\tonlineUsers: OnlineUsersData | null;\n\tisConnected: boolean;\n\tisInitialized: boolean;\n\treconnect: () => void;\n\tgetSessionData: () => SessionData | null;\n\tgetReferralData: () => ReferralData | null;\n}\n\nexport function useEngageTrack(\n\tconfig: EngageTrackConfig,\n\thooks: EngageTrackHooks = {}\n): UseEngageTrackReturn {\n\tconst [tracker, setTracker] = useState<EngageTracker | null>(null);\n\tconst [isInitialized, setIsInitialized] = useState(false);\n\tconst [sessionData, setSessionData] = useState<SessionData | null>(null);\n\tconst [onlineUsers, setOnlineUsers] = useState<OnlineUsersData | null>(null);\n\tconst [isConnected, setIsConnected] = useState(false);\n\n\tuseEffect(() => {\n\t\tif (typeof window === \"undefined\") return;\n\n\t\tconst trackerHooks: EngageTrackHooks = {\n\t\t\t...hooks,\n\t\t\tonSessionStart: (session) => {\n\t\t\t\tsetSessionData(session);\n\t\t\t\thooks.onSessionStart?.(session);\n\t\t\t},\n\t\t\tonSessionEnd: (session) => {\n\t\t\t\tsetSessionData(null);\n\t\t\t\thooks.onSessionEnd?.(session);\n\t\t\t},\n\t\t\tonWebSocketConnect: () => {\n\t\t\t\tsetIsConnected(true);\n\t\t\t\thooks.onWebSocketConnect?.();\n\t\t\t},\n\t\t\tonWebSocketDisconnect: () => {\n\t\t\t\tsetIsConnected(false);\n\t\t\t\thooks.onWebSocketDisconnect?.();\n\t\t\t},\n\t\t\tonOnlineUsersUpdate: (users) => {\n\t\t\t\tsetOnlineUsers(users);\n\t\t\t\thooks.onOnlineUsersUpdate?.(users);\n\t\t\t},\n\t\t};\n\n\t\ttry {\n\t\t\tconst trackerInstance = new EngageTracker(config, trackerHooks);\n\t\t\tsetTracker(trackerInstance);\n\t\t\tsetIsInitialized(true);\n\t\t} catch (error) {\n\t\t\tconsole.error(\"Failed to initialize EngageTracker:\", error);\n\t\t\thooks.onError?.(error as Error);\n\t\t}\n\n\t\treturn () => {\n\t\t\tif (tracker) {\n\t\t\t\ttracker.destroy();\n\t\t\t}\n\t\t};\n\t}, [config.siteId, config.domain]); // Only re-initialize if core config changes\n\n\tconst track = useCallback(\n\t\t(eventType: EventType, data?: TrackingData) => {\n\t\t\tif (tracker) {\n\t\t\t\ttracker.track(eventType, data);\n\t\t\t}\n\t\t},\n\t\t[tracker]\n\t);\n\n\tconst trackReferralConversion = useCallback(\n\t\t(data?: TrackingData) => {\n\t\t\tif (tracker) {\n\t\t\t\ttracker.trackReferralConversion(data);\n\t\t\t}\n\t\t},\n\t\t[tracker]\n\t);\n\n\tconst getSessionData = useCallback(() => {\n\t\treturn tracker?.getSessionData() || null;\n\t}, [tracker]);\n\n\tconst getReferralData = useCallback(() => {\n\t\treturn tracker?.getReferralData() || null;\n\t}, [tracker]);\n\n\tconst reconnect = useCallback(() => {\n\t\tif (tracker) {\n\t\t\ttracker.reconnect();\n\t\t}\n\t}, [tracker]);\n\n\treturn {\n\t\ttrack,\n\t\ttrackReferralConversion,\n\t\tsessionData,\n\t\tonlineUsers,\n\t\tisConnected,\n\t\tisInitialized,\n\t\treconnect,\n\t\tgetSessionData,\n\t\tgetReferralData,\n\t};\n}\n\n// Hook for tracking page views automatically\nexport function usePageView(path?: string): void {\n\tconst [currentPath, setCurrentPath] = useState<string>(\"\");\n\n\tuseEffect(() => {\n\t\tif (typeof window === \"undefined\") return;\n\n\t\tconst pathname = path || window.location.pathname;\n\n\t\tif (pathname !== currentPath) {\n\t\t\tsetCurrentPath(pathname);\n\t\t\t// Note: This requires the tracker to be initialized elsewhere\n\t\t\t// You would typically use this with the main useEngageTrack hook\n\t\t}\n\t}, [path, currentPath]);\n}\n\n// Hook for tracking custom events with automatic cleanup\nexport function useTrackEvent(\n\teventType: EventType,\n\tdata?: TrackingData,\n\tdependencies: any[] = []\n): void {\n\tuseEffect(() => {\n\t\t// This would need to be used within a component that has access to the tracker\n\t\t// Implementation would depend on how the tracker is provided (context or props)\n\t}, dependencies);\n}\n\n// Hook for online users with real-time updates\nexport function useOnlineUsers(): OnlineUsersData | null {\n\tconst [onlineUsers, setOnlineUsers] = useState<OnlineUsersData | null>(null);\n\n\tuseEffect(() => {\n\t\t// This would connect to the WebSocket for real-time updates\n\t\t// Implementation depends on the tracker being available\n\t}, []);\n\n\treturn onlineUsers;\n}\n\n// Hook for session data with automatic updates\nexport function useSessionData(): SessionData | null {\n\tconst [sessionData, setSessionData] = useState<SessionData | null>(null);\n\n\tuseEffect(() => {\n\t\t// This would connect to the tracker for session updates\n\t\t// Implementation depends on the tracker being available\n\t}, []);\n\n\treturn sessionData;\n}\n"],"names":["DEFAULT_CONFIG","serverUrl","wsUrl","idleTimeout","checkInterval","heartbeatInterval","maxReconnectAttempts","enableWebSocket","enableAutoTracking","enableReferralTracking","cookieExpiry","debug","REFERRAL_COOKIE_NAME","SESSION_COOKIE_NAME","USER_COOKIE_NAME","generateId","crypto","randomUUID","replace","c","r","Math","random","toString","setCookie","name","value","days","domain","cookieString","Date","now","toUTCString","trim","hostname","window","location","test","startsWith","document","cookie","getCookie","parts","split","length","_a","pop","shift","deleteCookie","parseReferralParams","urlParams","URLSearchParams","search","hashParams","hash","substring","referralParams","ref","get","referral","referrer","utm_source","utm_medium","utm_campaign","utm_term","utm_content","fbclid","gclid","msclkid","source","medium","campaign","affiliate","partner","Object","fromEntries","entries","filter","detectReferralSource","referrerDomain","URL","toLowerCase","knownSources","url","includes","error","getReferralData","existingReferral","referralSource","keys","referralData","timestamp","toISOString","landingPage","href","userAgent","navigator","cookieValue","encodeURIComponent","JSON","stringify","parse","decodeURIComponent","isLocalStorageAvailable","testKey","localStorage","setItem","removeItem","debounce","func","wait","timeout","args","clearTimeout","setTimeout","throttle","limit","inThrottle","EngageTracker","constructor","config","hooks","this","sessionData","ws","activityInterval","reconnectAttempts","onlineUsers","isInitialized","siteId","Error","init","initializeSession","setupEventListeners","connectWebSocket","startAutoTracking","track","trackReferral","handleError","console","warn","sessionId","cookieDomain","userId","startTime","lastActivity","isActive","timeSpent","_b","onSessionStart","call","updateActivity","forEach","event","addEventListener","passive","hidden","getTimeSpent","stopActivityTracking","startActivityTracking","e","target","closest","trackLinkClick","endSession","readyState","title","setInterval","checkActivity","clearInterval","currentTime","WebSocket","onopen","log","startHeartbeat","onWebSocketConnect","onmessage","message","data","handleWebSocketMessage","onclose","stopHeartbeat","onWebSocketDisconnect","scheduleReconnect","onerror","onWebSocketMessage","type","sendWebSocketMessage","_d","_c","onOnlineUsersUpdate","OPEN","send","sendHeartbeat","delay","min","pow","element","isExternal","textContent","preventDefault","trackWithNavigation","eventType","navigate","payload","buildTrackingPayload","sendBeacon","fetch","method","headers","body","keepalive","then","catch","toUpperCase","path","pathname","referer","referralDomain","referralUrl","utmSource","utmMedium","_e","utmCampaign","_f","referralCode","_g","_h","referralTimestamp","_k","_j","onReferralConversion","floor","sessionDuration","onSessionEnd","cleanup","close","onError","onTrackingEvent","trackReferralConversion","getSessionData","getOnlineUsers","isConnected","reconnect","destroy","useEngageTrack","tracker","setTracker","useState","setIsInitialized","setSessionData","setOnlineUsers","setIsConnected","useEffect","trackerHooks","session","users","trackerInstance","useCallback","usePageView","currentPath","setCurrentPath","useTrackEvent","dependencies","useOnlineUsers","useSessionData"],"mappings":"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"}